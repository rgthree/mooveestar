//  MooVeeStar 0.0.1.20130828 http://rgthree.github.io/mooveestar/
//  by Regis Gaughan, III <regis.gaughan@gmail.com>

(function(t){"use strict";var e=t.MooVeeStar=new Events;e.Model=new Class({Implements:[Events,Options],idProperty:"id",properties:{},_props:{},options:{autoinit:!0},initialize:function(t,e){this.setOptions(e),this.options.autoinit===!0&&this.init(t)},init:function(t,e){t=t&&"object"===typeOf(t)?t:{};var n=Object.map(Object.filter(this.properties,function(t){return null!=t.initial}),function(t){return t.initial});return this.set(Object.merge(n,t),e),!e&&this.fireEvent("ready"),this},fireEvent:function(t,e){Events.prototype.fireEvent.call(this,t,e),Events.prototype.fireEvent.call(this,"*",{event:t,message:e})},set:function(){var t;return this.changed=[],this.errors=[],"object"==typeof arguments[0]?(t=!!arguments[1],Object.forEach(arguments[0],function(e,n){this._set(n,e,t)}.bind(this))):(t=!!arguments[2],this._set.apply(this,arguments)),t||(this.changed.length&&this.fireEvent("change",this.get(this.changed)),this.errors.length&&this.fireEvent("error",this.errors)),this},_set:function(t,e,n){if(!t||e===void 0)return this;if(null!==e&&this.properties[t]&&this.properties[t].sanitize&&(e=this.properties[t].sanitize(e)),this.properties[t]&&this.properties[t].set)this.properties[t].set.call(this,e,t);else{if(this._props[t]&&this._props[t]===e)return this;var i=this.validate(t,e);if(this.properties[t]&&this.properties[t].validate&&i!==!0){var s={key:t,value:e,error:i};return this.errors.push(s),this.fireEvent("error:"+t,s),this}null===e?delete this._props[t]:this._props[t]=e}return this.changed.push(t),!n&&this.fireEvent("change:"+t,e),this},get:function(t,e){if("array"===typeOf(t)){var n,i;return n=this,i={},Array.forEach(t,function(t){i[t]=n._get(t,e)}),i}return this._get(t,e)},_get:function(t,e){return!e&&this.properties[t]&&this.properties[t].get?this.properties[t].get.apply(this,arguments):"cid"===t?this.cid||this.getId():t&&this._props[t]!==void 0?this._props[t]:null},getId:function(){var t=this.get(this.idProperty)||this.cid||String.uniqueID();return!this.cid&&(this.cid=t),t},unset:function(t){if(t=[t].flatten().clean(),!t.length)return this;var e={};return t.forEach(function(t){e[t]=null}),this.set(e)},destroy:function(){var t,e;e=this.getId(),t=Object.clone(this.toJSON()),this._props={},this.fireEvent("destroy",{model:this,properties:t,id:e})},validate:function(t,e){return this.properties[t]&&this.properties[t].validate?this.properties[t].validate.call(this,e):!0},toJSON:function(){var t,e;return e=function(t,n,i){t&&(t.toJSON?i[n]=t.toJSON():"object"===typeOf(t)?Object.each(t,e):"array"===typeOf(t)&&Array.each(t,e))}.bind(this),t=Object.clone(this._props),e(t),t}}),e.Collection=new Class({Implements:[Events,Options],model:e.Model,options:{silent:!1},_models:[],initialize:function(t,e){e=e||{},this._onModelEvent=this._onModelEvent.bind(this),this.cid=e.id||String.uniqueID(),delete e.id,this.setOptions(e),this.silent=!!e.silent,t&&this.add(t,{silent:!0})},_onModelEvent:function(t){"destroy"===t.event&&this.remove(t.message.model),this.fireEvent(t.event,t.message)},silence:function(){return"boolean"==typeof arguments[0]?this.silent=arguments[0]:"function"==typeof arguments[0]?(this.silent=!0,arguments[0](),this.silent=!1):0===arguments.length&&(this.silent=!0),this},add:function(t,e){var n;e=e||{},n=[],Array.forEach([t].flatten(),function(t){var e=this.model?t instanceof this.model?t:new this.model(t):t;this.findFirst(e.getId())||(e.addEvent("*",this._onModelEvent),n.push(e))}.bind(this)),n.length&&(null!=e.at?Array.prototype.splice.apply(this._models,[e.at,0].concat(n)):Array.combine(this._models,n)),this.silent||e.silent||!n.length||(this.fireEvent("change",{event:"add",models:n,options:e}),this.fireEvent("add",{models:n,options:e}))},remove:function(t,e){var n=[];e=e||{},/number|string/.test(typeof t)&&(t=this.get(t)),t=[t].flatten(),t.each(function(t){t="string"==typeof t?this.findFirst(t):t,this._models.contains(t)&&(t.removeEvent("*",this._onModelEvent),n.include(t),this._models.erase(t))}.bind(this)),this.silent||e.silent||!n.length||(this.fireEvent("change",{event:"remove",models:n,options:e}),this.fireEvent("remove",{models:n,options:e}))},move:function(t,e,n){var i;n=n||{},t=t instanceof this.model?t:this.get(t),i=this.indexOf(t),null==e||e>this.getLength()?Array.push(this._models,Array.splice(this._models,i,1)[0]):Array.splice(this._models,e,0,Array.splice(this._models,i,1)[0]),this.silent||n.silent||(this.fireEvent("change",{event:"move",model:t,from:i,to:this.indexOf(t),options:n}),this.fireEvent("move",{model:t,from:i,to:this.indexOf(t),options:n}))},getId:function(){return this.cid},getLength:function(){return this._models.length},at:function(t){return this._models[t]},get:function(t){return null==t?this.getAll():this.findFirst(t)||"number"==typeof t&&this.at(t)},getAll:function(){return this._models},find:function(t,e){return e=e||null,t=[t].flatten(),this._models.filter(function(n){return t.contains(e?n.get(e):n.getId())})},findFirst:function(t,e){var n=this.find(t,e);return n.length?n[0]:null},toJSON:function(){return Array.map(this._models,function(t){return t.toJSON()})},set:function(){var t=arguments;Array.forEach(this._models,function(e){e.set.apply(e,t)})}}),Array.each(["forEach","each","every","invoke","filter","map","some","indexOf","contains","getRandom","getLast"],function(t){e.Collection.implement(t,function(){return Array.prototype[t].apply(this._models,arguments)})}),e.View=new Class({Implements:[Events,Options],options:{autoattach:!0,autorender:!0,inflater:null,binder:null},events:{},template:null,element:null,elements:{},initialize:function(t,n){n=n||{},n.inflater=n.inflater||this.options.inflater||e.Templates&&e.Templates.inflate||null,n.binder=n.binder||this.options.binder||e.Templates&&e.Templates.init||null,this.setOptions(n),this.events=Object.clone(this.events||{}),this.model=this.model||t||null,this.setElement(),this.options.autoattach&&this.attachEvents(),this.options.autorender&&this.render()},setElement:function(t){return this.element||(this.element=$(t),!this.element&&this.template&&this.options.inflater&&(this.element=this.options.inflater(this.template,null,!0))),this.element&&(this.element.set("data-autobind","false"),this.element.set("data-has-view-controller","true"),this.element.store("__view",this),this.elements.container=this.element),this},toElement:function(){return this.element},render:function(t){return this.options.binder&&this.options.binder(this.element,t||this.model&&this.model.toJSON()||{}),this},_doDomManipulation:function(t,e){return t=t||"dispose",this.detach(e,"empty"===t),(e||this.element)[t](),this.fireEvent(t),this},dispose:function(t){return this._doDomManipulation("dispose",t)},destroy:function(t){return this._doDomManipulation("destroy",t)},empty:function(t){return this._doDomManipulation("empty",t)},_doAttachDetach:function(t,e,n){return e=e||this.element,t=t||"attach",Array.each(Array.combine([n===!0?null:e],e.getElements("*[data-has-view-controller]")).clean(),function(e){var n=e.retrieve("__view");n&&(n[t+"Events"](),"attach"===t&&n.render())}),this},attach:function(t,e){return this._doAttachDetach("attach",t,e)},detach:function(t,e){return this._doAttachDetach("detach",t,e)},attachEvents:function(){return this._attachedEvents=this._attachedEvents||{},this._boundEventFns=this._boundEventFns||{},Object.each(this.events,function(t,e){if(!this._attachedEvents[e]&&e&&e.length&&"function"===typeOf(this[t])){var n,i;if(e.contains(":")&&!/\:relay\(/gi.test(e)||null==Element.NativeEvents[e.substr(0,e.indexOf(":")>0?e.indexOf(":"):e.length)]?/attach\(([^\)]+)/gi.test(e)?(i=/attach\(([^\)]+)/gi.exec(e),n=e.replace(/:?attach\([^\)]+\)/i,""),i=i&&i[1],i=this._getEventObj(i)||this):(i=e.split(":")[0],n=e.replace(i+":",""),i=this._getEventObj(i)||this):(i=$(this.element),n=e),!(i&&n&&i.addEvent))throw Error('[VIEW ERROR] Could not attach event "'+e+'". Something went awry.');this._boundEventFns[t]=this._boundEventFns[t]||this[t].bind(this),i.addEvent(n,this._boundEventFns[t]),this._attachedEvents[e]={attach:i,name:n,fn:this._boundEventFns[t]}}}.bind(this)),this},detachEvents:function(){return Object.each(this._attachedEvents||{},function(t){t.attach.removeEvent(t.name,t.fn)}),this._attachedEvents={},this},_getEventObj:function(n){var i,s;if("this"===n)return this;if("window"===n)return $(window);if("document"===n)return $(document);if("MooVeeStar"===n)return e;if($(n))return $(n);if(t[n]&&"function"===typeOf(t[n].addEvent))return t[n];s=(n||"").replace(/^this\./gi,"").split("."),i=this;for(var r=0,a=s.length;a>r;r++){if(void 0===i[s[r]])throw Error('[VIEW ERROR] Could not attach event to this["'+n.replace(".",'"]["')+'"]. "'+s[r]+'" is undefined.');i=i[s[r]]}if(i&&"function"===typeOf(i.addEvent))return i;if(!i||"function"!==typeOf(i.addEvent))throw Error("[VIEW ERROR] Could not attach event to this["+n.replace(".","][")+"], it does not have an addEvent method.");return null}}),e.Storage=new Class({store:function(){try{t.localStorage.setItem(this.getId(),JSON.encode(this.toJSON())),this.fireEvent("store")}catch(e){}},retrieve:function(){try{var e=t.localStorage.getItem(this.getId());return this.fireEvent("retrieve"),JSON.decode(e)}catch(n){}},eliminate:function(){return t.localStorage.removeItem(this.getId()),this.fireEvent("eliminate")}});var n={templates:{},cleanKey:function(t){return t.toLowerCase().trim().replace(/\s/g,"")},register:function(t,e){return"function"==typeof e?(n.registerScript(t,e),void 0):(t=n.cleanKey(t),e=e.replace(/<\!\-\-.*?\-\->/g,"").trim().replace(/\n/g," ").replace(/\s+/g," "),n.templates[t]=n.templates[t]||{},n.templates[t].dom=new Element('markup[html="'+e+'"]'),n.templates[t].markup=e,void 0)},registerScript:function(t,e){t=n.cleanKey(t),n.templates[t]=n.templates[t]||{},n.templates[t].script=e},getScript:function(t){if(t=n.cleanKey(t),n.templates[t]&&n.templates[t].script)return n.templates[t].script;throw Error("Ain't no script for the template called "+t+" ("+typeOf(n.templates[t].script)+")")},check:function(t){return!!n.templates[n.cleanKey(t)]},get:function(t){var e;if(t=n.cleanKey(t),e=n.templates[t]){if(window.html5&&window.html5.supportsUnknownElements===!1){var i=html5.createElement("markup");return i.innerHTML=e.markup,$(i).set("data-templateid",t)}return e.dom.clone().set("data-templateid",t)}throw Error("Ain't no template called "+t+" ("+typeOf(n.templates[t])+")")},inflateOnce:function(t,e,i){var s=n.inflate(t,e,i);return[s||[]].flatten().each(function(t){t.removeProperty("data-bind"),t.getElements("[data-bind]").removeProperty("data-bind")}),s},inflate:function(t,e,i){if("string"===typeOf(t)&&(t=n.get(t)),t){var s;return t.getElements("markup").each(function(t){var s,r;r=t.get("class")||null,s=n.inflate(t.get("template"),e,null!=i?i:!0),s="array"!==typeOf(s)?[s]:s,s.reverse().each(function(e){e.inject(t,"after"),r&&e.addClass(r)}),t.destroy()}),s=t.getChildren(),s.each(function(e){e.set("data-tpl",(e.get("data-tpl")||"").split(" ").include(t.get("data-templateid")).join(" ").clean())}),s=1===s.length?s[0]:s,!i&&n.init(s,e),s}return null},inflateSurround:function(t,e,i,s){var r,a;if(i=i||{},r="element"===typeOf(t)||"elements"===typeOf(t)||"array"===typeOf(t)?t:n.inflate(t,i,s)){if(e&&n.check(e))return a=(i||{})[e]||(i||{}).surround||{},a.els=r,n.inflate(e,a);throw Error("Could not find the surround template: "+e)}},init:function(t,e){(t?"element"===typeOf(t)?[t]:t:[]).each(function(t){if(t.get("data-tpl")){var i=t.get("data-tpl").split(" ");i.each(function(i){n.templates[i].script?n.templates[i].script(t,e&&(e[i]||e[i.replace("tpl:","")])||e):n.bind(t,e)})}else n.bind(t,e)})},bind:function(t,e){e=e||{},"string"!==typeOf(e)||"element"!==typeOf(t)||0!==t.getChildren().length||t.get("data-bind")||(t.set("data-bind","value"),e={value:e}),(t?"element"===typeOf(t)?[t]:t:[]).each(function(t){var i,s;i=t.getElements("[data-bind]"),t.get("data-bind")&&i.unshift(t),i.length&&(s=t.getElements("*[data-tpl] *[data-bind]"),i=i.filter(function(t){return!s.contains(t)}),i.each(function(t){var i;i=t.get("data-bind").replace(/\s+/," ").trim().split(" ")||[],i.each(function(i){var s,r;r=e[i],void 0===r&&(r=null),s=t.get("data-bind-"+i)?t.get("data-bind-"+i).split(" "):["default"],s.each(function(e){if(0===e.indexOf("style:"))r=r&&0===r.indexOf("http")?"url("+r+")":r,t.setStyle(e.replace("style:",""),r);else if(0===e.indexOf("tpl:")&&n.check(e.replace("tpl:","")))if(t.empty(),"array"===typeOf(r)){var s=document.createDocumentFragment();r.each(function(t){var i=n.inflate(e.replace("tpl:",""),t,!1);i.removeProperty("data-tpl").getElements("*[data-tpl]").removeProperty("data-tpl"),s.appendChild(i)}),t.empty().appendChild(s)}else r&&t.grab(n.inflate(e.replace("tpl:",""),r));else"class"===e||"class"===i&&"default"===e?r&&t.addClass(r):"html"!==e&&"default"!==e||"element"!==typeOf(r)?"default"===e?(e=/input|textarea|select/.test(t.get("tag"))?"value":"html",t.set(e,null!==r?r:"")):null!==r?t.set(e,r):t.removeProperty(e,r):t.empty().grab(r)})})}));var r,a;r=t.getElements("*[data-tpl]"),r.length&&(a=t.getElements("*[data-tpl] *[data-tpl]"),r=r.filter(function(t){if(a.contains(t))return!1;var n=t.get("data-tpl");return e&&(e[n]||e[n.replace("tpl:","")])?!0:"false"!==t.get("data-autobind")}),r.each(function(t){var i=t.get("data-tpl");n.init(t,e&&(e[i]||e[i.replace("tpl:","")])||e)}))})},scrape:function(){$$('script[type="text/x-tpl"]').each(function(t){n.register(t.get("id"),t.get("text")),t.destroy()})}};e.Templates=n,window&&window.html5&&window.html5.supportsUnknownElements===!1&&(window.html5.elements+=" markup",html5.shivDocument(document)),document.createElement("markup"),e.Templates.scrape()})(this);